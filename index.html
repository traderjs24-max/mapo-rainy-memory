<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0a0a0d" />
  <meta name="description" content="Mapo Rainy... Memory â€” ë¹„, í´ë˜ì‹, ê¸°ë¡. ì¡°ìš©íˆ ë¨¸ë¬´ëŠ” ê°œì¸ í™ˆ." />

  <meta property="og:title" content="Mapo Rainy... Memory" />
  <meta property="og:description" content="ë¹„, í´ë˜ì‹, ê¸°ë¡. ì¡°ìš©íˆ ë¨¸ë¬´ëŠ” ê°œì¸ í™ˆ." />
  <meta property="og:type" content="website" />

  <title>Mapo Rainy... Memory</title>

  <!-- Elegant fonts (fallback to system if blocked) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Noto+Sans+KR:wght@200;300;400;500;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg0:#07070a;
      --bg1:#0b0b10;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --line:rgba(255,255,255,.14);
      --line2:rgba(255,255,255,.08);
      --glass:rgba(0,0,0,.42);
      --glass2:rgba(0,0,0,.58);
      --paper:rgba(255,255,255,.95);
      --ink:#0b0b0f;
      --shadow:0 24px 90px rgba(0,0,0,.55);
      --shadow2:0 14px 50px rgba(0,0,0,.45);
      --r:18px;
      --r2:28px;
      --ok:#a6ffd8;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:transparent;color:var(--text);overflow:hidden}
    body{
      font-family:"Noto Sans KR",system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Malgun Gothic",sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    button,input,textarea{font:inherit}
    a{color:inherit}

    /* ===== Background (video + subtle layers) ===== */

    .bgVideo{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      z-index:0;                 /* keep non-negative to avoid being painted behind body */
      filter: contrast(1.05) saturate(1.05) brightness(1.05);
      transform: scale(1.02);
    }
    .bg{
      position:fixed;inset:0;z-index:1;
      /* IMPORTANT: keep this overlay TRANSPARENT so the video is visible */
      background:
        radial-gradient(1200px 700px at 50% 22%, rgba(255,255,255,.08) 0%, rgba(255,255,255,0) 58%),
        radial-gradient(900px 520px at 18% 38%, rgba(255,255,255,.05) 0%, rgba(255,255,255,0) 62%),
        radial-gradient(900px 520px at 86% 42%, rgba(255,255,255,.04) 0%, rgba(255,255,255,0) 62%),
        linear-gradient(180deg, rgba(0,0,0,.22) 0%, rgba(0,0,0,.32) 55%, rgba(0,0,0,.46) 100%);
    }
    /* (Video-first) Background uses london_rain.mp4 */
        .vignette{
      position:fixed;inset:0;z-index:2;pointer-events:none;
      background:radial-gradient(1100px 620px at 50% 38%, rgba(0,0,0,.06) 0%, rgba(0,0,0,.60) 60%, rgba(0,0,0,.70) 100%);
    }
    .rain{
      position:fixed;inset:-70px;z-index:3;pointer-events:none;
      opacity:.34;
      background-image:
        linear-gradient(115deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0) 44%, rgba(255,255,255,.34) 50%, rgba(255,255,255,0) 56%, rgba(255,255,255,0) 100%),
        linear-gradient(115deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0) 33%, rgba(255,255,255,.20) 40%, rgba(255,255,255,0) 47%, rgba(255,255,255,0) 100%);
      background-size:240px 240px, 360px 360px;
      animation:rainMove .95s linear infinite;
      filter: blur(.25px);
    }
    @keyframes rainMove{
      from{background-position:0 0,0 0}
      to{background-position:-240px 520px,-360px 760px}
    }
    .grain{
      position:fixed;inset:0;z-index:4;pointer-events:none;
      opacity:.07;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      mix-blend-mode:overlay;
    }

    /* ===== Center stage ===== */
    .wrap{
      position:relative;
      z-index:10;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 22px 18px 160px;
      text-align:center;
    }
    .hero{
      width:min(980px, 96vw);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 14px;
    }

    /* Title (one-line typing, white) */
    .title{
      font-family:"Cormorant Garamond",serif;
      font-weight:600;
      letter-spacing:-1.2px;
      font-size: clamp(2.8rem, 5vw, 5.0rem);
      line-height: 1.05;
      text-shadow: 0 18px 60px rgba(0,0,0,.65);
      user-select:none;
      white-space:nowrap;
    }
    .title .cursor{
      display:inline-block;
      width: 3px;
      height: 1.05em;
      background: rgba(255,255,255,.92);
      border-radius: 8px;
      margin-left: 8px;
      transform: translateY(2px);
      animation: caretBlink .9s steps(1) infinite;
      box-shadow: 0 0 18px rgba(255,255,255,.18);
    }
    @keyframes caretBlink{ 0%,49%{opacity:1} 50%,100%{opacity:0} }

    .subtitle{
      font-size: 1.02rem;
      font-weight: 300;
      letter-spacing: 1.2px;
      opacity:.86;
    }

    .clock{
      margin-top: 6px;
      font-size: .88rem;
      letter-spacing: 1px;
      opacity:.82;
      border: 1px solid rgba(255,255,255,.22);
      padding: 7px 16px;
      border-radius: 999px;
      backdrop-filter: blur(12px);
      background: rgba(0,0,0,.18);
      user-select:none;
    }

    .start{
      margin-top: 18px;
      padding: 14px 26px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.40);
      background: rgba(0,0,0,.16);
      color: rgba(255,255,255,.95);
      cursor:pointer;
      transition: .22s ease;
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
      font-weight: 600;
    }
    .start:hover{ background: rgba(255,255,255,.92); color:#000; transform: translateY(-2px); }
    .start:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    /* Now playing (width matches dock, thickness similar) */
    .now{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: 88px;
      width: min(980px, 96vw);
      display:none;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.52);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      z-index: 40;
    }
    .now .dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(255,255,255,.35);
      box-shadow: 0 0 14px rgba(255,255,255,.14);
      flex:0 0 auto;
    }
    .now .meta{
      text-align:left;
      min-width:0;
      flex: 1 1 auto;
    }
    .now .t{
      font-size: .95rem;
      font-weight: 700;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .now .a{
      font-size: .78rem;
      opacity:.68;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .now .ctrl{ display:flex; gap: 8px; flex:0 0 auto; }
    .icon{
      width: 40px; height: 36px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.95);
      cursor:pointer;
      transition: .18s ease;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
      font-weight: 900;
    }
    .icon:hover{ background: rgba(255,255,255,.14); transform: translateY(-1px); }
    .icon.active{ background: rgba(255,255,255,.16); border-color: rgba(255,255,255,.22); }

    /* Dock (5 buttons) */
    .dock{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: 20px;
      width: min(980px, 96vw);
      display:none;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.56);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 60px rgba(0,0,0,.48);
      z-index: 50;
      justify-content:center;
      flex-wrap:wrap;
    }
    .dockBtn{
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      transition: .18s ease;
      user-select:none;
      font-weight: 600;
      white-space: nowrap;
      font-size: .92rem;
    }
    .dockBtn:hover{ background: rgba(255,255,255,.14); transform: translateY(-1px); }

    /* Mixer: dock-width, sits above dock like a sheet */
    .mixer{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: 132px; /* above now bar */
      width: min(980px, 96vw);
      display:none;
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding: 16px 16px 14px;
      text-align:left;
      z-index: 60;
    }
    .mixer .head{
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom: 12px;
    }
    .mixer .head .h{ font-weight: 800; letter-spacing:.2px }
    .pill{
      font-size:.72rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      opacity:.9;
      user-select:none;
    }
    .mixer .row{ display:flex;align-items:center;gap: 10px;margin-bottom: 10px; }
    .mixer .lab{ width: 80px; font-size: .88rem; opacity:.9; }
    input[type="range"]{
      -webkit-appearance:none; appearance:none;
      width:100%; height: 6px;
      border-radius:999px;
      background: rgba(255,255,255,.22);
      outline:none;
      cursor:pointer;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none;
      width: 18px; height: 18px;
      border-radius: 50%;
      background: rgba(255,255,255,.96);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    .togRow{
      margin-top: 8px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .switch{
      position:relative;width: 44px;height: 26px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      cursor:pointer; transition:.18s ease;
      flex:0 0 auto;
    }
    .switch::after{
      content:"";
      position:absolute; top: 3px; left: 3px;
      width: 20px; height: 20px; border-radius: 50%;
      background: rgba(255,255,255,.92);
      transition:.18s ease;
    }
    .switch.on{ background: rgba(166,255,216,.16); border-color: rgba(166,255,216,.32); }
    .switch.on::after{ left: 21px; background: rgba(166,255,216,.95); }

    /* ===== Modals ===== */
    .overlay{
      display:none;
      position:fixed; inset:0;
      z-index: 200;
      background: rgba(0,0,0,.70);
      backdrop-filter: blur(14px);
      align-items:center;
      justify-content:center;
      padding: 16px;
    }
    .modal{
      width: min(1100px, 96vw);
      height: min(86vh, 900px);
      border-radius: var(--r2);
      overflow:hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.36);
      backdrop-filter: blur(14px);
      display:flex;
      flex-direction:column;
    }
    .modalHeader{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap: 12px;
      padding: 18px 20px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.28) 0%, rgba(0,0,0,.00) 100%);
    }
    .modalHeader .h{
      font-size: 1.18rem;
      font-weight: 800;
      letter-spacing: -.2px;
    }
    .modalHeader .s{
      font-size: .86rem;
      opacity: .70;
      line-height: 1.4;
    }
    .close{
      width: 44px; height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-size: 1.5rem;
      font-weight: 300;
      transition: .18s ease;
      user-select:none;
      display:flex; align-items:center; justify-content:center;
    }
    .close:hover{ background: rgba(255,255,255,.16); transform: rotate(90deg); }
    .modalBody{
      flex:1;
      overflow:auto;
      padding: 16px 20px 20px;
    }

    /* Music Room layout */
    .musicRoom{
      display:grid;
      grid-template-columns: 1fr 1.1fr;
      gap: 14px;
      height: 100%;
    }
    .panel{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      padding: 14px 14px 12px;
      overflow:auto;
    }
    .tools{
      position: sticky;
      top: 0;
      z-index: 2;
      padding-bottom: 10px;
      background: linear-gradient(180deg, rgba(0,0,0,.70) 0%, rgba(0,0,0,0) 100%);
      backdrop-filter: blur(8px);
    }
    .search{
      display:flex; align-items:center; gap: 8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .search input{
      width:100%;
      border:none; outline:none;
      background: transparent;
      color: rgba(255,255,255,.94);
      font-size: .92rem;
    }
    .search input::placeholder{ color: rgba(255,255,255,.55); }
    .rowBtns{ margin-top: 10px; display:flex; gap: 10px; flex-wrap:wrap; }
    .softBtn{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      transition: .18s ease;
      user-select:none;
      font-weight: 600;
      font-size: .88rem;
    }
    .softBtn:hover{ background: rgba(255,255,255,.14); transform: translateY(-1px); }

    .track{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      padding: 12px 12px;
      margin: 8px 0;
      cursor:pointer;
      transition: .18s ease;
      display:flex; justify-content:space-between; align-items:center;
      color: rgba(255,255,255,.76);
    }
    .track:hover{ background: rgba(255,255,255,.08); transform: translateX(2px); color: rgba(255,255,255,.95); }
    .track.active{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.16); color: rgba(255,255,255,.98); }
    .track .tt{ font-size: 1.02rem; font-weight: 800; }
    .track .aa{ font-size: .78rem; opacity: .70; font-weight: 300; margin-top: 2px; }

    .infoTitle{
      font-family:"Cormorant Garamond",serif;
      font-size: 2.0rem;
      font-weight: 600;
      letter-spacing: -.8px;
      line-height: 1.15;
    }
    .infoArtist{ font-size: 1rem; opacity: .72; font-weight: 300; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,.12); }
    .infoDesc{ margin-top: 12px; font-size: 1rem; line-height: 1.75; opacity: .88; white-space: pre-line; font-weight: 300; }

    .player{
      margin-top: 14px;
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .big{
      width: 44px; height: 42px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      cursor:pointer;
      transition: .18s ease;
      color: rgba(255,255,255,.95);
      user-select:none;
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
    }
    .big:hover{ background: rgba(255,255,255,.16); transform: translateY(-1px); }
    .prog{
      flex: 1;
      min-width: 240px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 10px 12px;
      display:flex; align-items:center; gap: 10px;
    }
    .time{
      width: 54px;
      text-align:center;
      font-size: .78rem;
      opacity: .78;
      user-select:none;
    }

    /* Writing / Guestbook: brighter paper for readability */
    .paper{
      background: var(--paper);
      color: var(--ink);
      border: 1px solid rgba(255,255,255,.18);
    }
    .paper .modalHeader{
      border-bottom: 1px solid rgba(0,0,0,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.98) 0%, rgba(255,255,255,.92) 100%);
    }
    .paper .modalHeader .s{ opacity:.62 }
    .paper .close{
      border-color: rgba(0,0,0,.10);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.70);
    }
    .paper .close:hover{ background: rgba(0,0,0,.08); }
    .field{
      display:flex;
      flex-direction:column;
      gap: 8px;
      margin-bottom: 14px;
    }
    .field label{ font-weight: 700; font-size: .92rem; opacity:.92 }
    .paper input[type="text"], .paper textarea{
      width:100%;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.98);
      padding: 12px 12px;
      outline:none;
      font-size: .95rem;
      line-height: 1.65;
    }
    .paper textarea{ min-height: 220px; resize: vertical; }
    .paper .actions{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .paper .act{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.78);
      cursor:pointer;
      transition:.18s ease;
      font-weight: 700;
    }
    .paper .act:hover{ background: rgba(0,0,0,.08); transform: translateY(-1px); }

    .entries{
      margin-top: 18px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .entry{
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.98);
      box-shadow: 0 12px 40px rgba(0,0,0,.08);
      padding: 14px 14px 12px;
    }
    .entry .t{ font-weight: 900; font-size: 1.02rem; letter-spacing: -.2px; }
    .entry .d{ margin-top: 6px; font-size: .78rem; opacity:.56; }
    .entry .c{ margin-top: 10px; font-size: .94rem; line-height: 1.72; opacity:.88; white-space: pre-line; }
    .entry .mini{ margin-top: 12px; display:flex; gap: 8px; flex-wrap:wrap; }
    .chip{
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.04);
      font-size: .74rem;
      opacity:.78;
    }

    /* Map */
    .mapBox{
      border-radius: var(--r2);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.55);
      position:relative;
      height: 100%;
    }
    .mapPlaceholder{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
      text-align:center;
      color: rgba(255,255,255,.92);
      background:
        radial-gradient(900px 520px at 50% 20%, rgba(255,255,255,.08) 0%, rgba(255,255,255,0) 60%),
        rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
    }
    .mapInner{
      width: min(760px, 92vw);
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.40);
      padding: 22px 20px 18px;
      box-shadow: 0 20px 70px rgba(0,0,0,.40);
    }
    .mapInner .h{ font-size: 1.4rem; font-weight: 800; letter-spacing: -.4px; }
    .mapInner .p{ margin-top: 10px; font-size: .95rem; opacity: .78; line-height: 1.65; }
    .mapInner .small{ margin-top: 10px; font-size: .82rem; opacity: .62; line-height: 1.5; }
    .mapInner .row{ margin-top: 14px; display:flex; gap: 10px; justify-content:center; flex-wrap:wrap; }
    .mapFrame{
      width:100%;
      height:100%;
      border:0;
      filter: invert(100%) hue-rotate(180deg) contrast(1.18) grayscale(.2);
      display:none;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: 8px;
      z-index: 999;
      opacity:0;
      pointer-events:none;
      transition:.22s ease;
      background: rgba(0,0,0,.78);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
      padding: 10px 14px;
      border-radius: 999px;
      box-shadow: 0 12px 45px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
      max-width: min(92vw, 760px);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }

    /* Responsive */
    @media (max-width: 980px){
      .musicRoom{ grid-template-columns: 1fr; }
      .entries{ grid-template-columns: 1fr; }
    }
    @media (max-width: 560px){
      .wrap{ padding-bottom: 190px; }
      .dock{ gap: 8px; padding: 10px 10px; }
      .dockBtn{ padding: 9px 12px; font-size: .9rem; }
      .now{ bottom: 96px; padding: 10px 10px; }
      .now .ctrl{ gap: 6px; }
      .icon{ width: 38px; height: 36px; }
      .mixer{ bottom: 148px; padding: 14px; }
    }
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
      .rain{ display:none; }
      .title .cursor{ display:none; }
      .title{ font-size: clamp(2.2rem, 8vw, 4.0rem); letter-spacing:-.8px; }
    }
  
    /* ===== Video-first mode =====
       We use the real london_rain.mp4 as the rain background.
       CSS rain streaks are ONLY a fallback if the video cannot load. */
    .rain{ opacity:0 !important; }
    html.noVideo .rain{ opacity:1 !important; }

  
    /* Video loading veil: fades out when the first frame is ready */
    .videoVeil{
      position:fixed;
      inset:0;
      z-index:2; /* above video(0), below content(10) */
      pointer-events:none;
      background:
        radial-gradient(1200px 700px at 50% 22%, rgba(255,255,255,.08) 0%, rgba(255,255,255,0) 58%),
        radial-gradient(900px 520px at 18% 38%, rgba(255,255,255,.05) 0%, rgba(255,255,255,0) 62%),
        radial-gradient(900px 520px at 86% 42%, rgba(255,255,255,.04) 0%, rgba(255,255,255,0) 62%),
        linear-gradient(180deg, rgba(0,0,0,.55) 0%, rgba(0,0,0,.62) 55%, rgba(0,0,0,.78) 100%);
      opacity:1;
      transition: opacity 900ms ease;
    }
    body.video-ready .videoVeil{ opacity:0; }

  </style>
</head>
<body>

  <!-- Background Video -->
  <video class="bgVideo" id="bgVideo" autoplay muted loop playsinline preload="auto" aria-hidden="true">
    <source src="london_rain.mp4" type="video/mp4" />
  </video>
  <div class="videoVeil" id="videoVeil" aria-hidden="true"></div>

  <div class="bg"></div>
  <div class="rain"></div>
  <div class="grain"></div>
  <div class="vignette"></div>

  <!-- Audio -->
  <audio id="music" preload="metadata"></audio>
  <audio id="rainAudio" loop preload="metadata">
    <source src="rain_sound.mp3" type="audio/mp3" />
  </audio>

  <main class="wrap">
    <section class="hero" aria-live="polite">
      <h1 class="title"><span id="typing"></span><span class="cursor" aria-hidden="true"></span></h1>
      <p class="subtitle">ë¹„ ì†Œë¦¬ ìœ„ì— í´ë˜ì‹, ê·¸ë¦¬ê³  ê¸°ë¡</p>
      <div class="clock" id="clock">SEOUL 00:00:00</div>
      <button class="start" id="startBtn">ì‚°ì±… ì‹œì‘í•˜ê¸°</button>
    </section>
  </main>

  <!-- Now Playing -->
  <section class="now" id="nowBar" role="region" aria-label="Now Playing">
    <div class="dot" id="playDot" aria-hidden="true"></div>
    <div class="meta">
      <div class="t" id="nowTitle">â€”</div>
      <div class="a" id="nowArtist">â€”</div>
    </div>
    <div class="ctrl">
      <button class="icon" id="prevBtn" title="ì´ì „ (â†)" aria-label="ì´ì „ íŠ¸ë™">âŸ¨</button>
      <button class="icon" id="playBtn" title="ì¬ìƒ/ì¼ì‹œì •ì§€ (Space)" aria-label="ì¬ìƒ/ì¼ì‹œì •ì§€">â–¶</button>
      <button class="icon" id="nextBtn" title="ë‹¤ìŒ (â†’)" aria-label="ë‹¤ìŒ íŠ¸ë™">âŸ©</button>
      <button class="icon" id="shuffleBtn" title="ì…”í”Œ" aria-label="ì…”í”Œ">ğŸ”€</button>
      <button class="icon" id="repeatBtn" title="ë°˜ë³µ" aria-label="ë°˜ë³µ">ğŸ”</button>
    </div>
  </section>

  <!-- Dock -->
  <nav class="dock" id="dock" aria-label="Menu">
    <button class="dockBtn" data-open="musicModal">ğŸ§ Playlist</button>
    <button class="dockBtn" data-open="diaryModal">ğŸ“– Diary</button>
    <button class="dockBtn" data-open="novelModal">âœï¸ Writing</button>
    <button class="dockBtn" data-open="guestModal">ğŸ–Šï¸ Guestbook</button>
    <button class="dockBtn" data-open="mapModal">ğŸ—ºï¸ Map</button>
    <button class="dockBtn" id="mixerBtn" title="ë¯¹ì„œ">ğŸ›ï¸</button>
  </nav>

  <!-- Mixer -->
  <section class="mixer" id="mixer" aria-label="Sound Mixer">
    <div class="head">
      <div class="h">Sound Mixer</div>
      <span class="pill" id="policyHint">í´ë¦­ í›„ ì¬ìƒ</span>
    </div>
    <div class="row">
      <div class="lab">Master</div>
      <input type="range" id="vMaster" min="0" max="1" step="0.05" value="0.80" />
    </div>
    <div class="row">
      <div class="lab">Music</div>
      <input type="range" id="vMusic" min="0" max="1" step="0.05" value="0.55" />
    </div>
    <div class="row">
      <div class="lab">Rain</div>
      <input type="range" id="vRain" min="0" max="1" step="0.05" value="0.55" />
    </div>

    <div class="togRow">
      <div style="opacity:.88;font-size:.88rem;">Music</div>
      <div class="switch on" id="togMusic" role="switch" aria-checked="true" tabindex="0"></div>
      <div style="opacity:.88;font-size:.88rem;">Rain</div>
      <div class="switch on" id="togRain" role="switch" aria-checked="true" tabindex="0"></div>
      <div style="opacity:.70;font-size:.82rem;margin-left:auto;">Space Â· â†/â†’ Â· Esc</div>
    </div>
  </section>

  <!-- ===== Modals ===== -->

  <!-- Music -->
  <section class="overlay" id="musicModal" aria-modal="true" role="dialog" aria-label="Playlist">
    <div class="modal">
      <header class="modalHeader">
        <div>
          <div class="h">Playlist</div>
          <div class="s">í´ë˜ì‹ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ + ë‚´ ì˜¤ë””ì˜¤ íŒŒì¼ ì¶”ê°€</div>
        </div>
        <button class="close" data-close="musicModal" aria-label="ë‹«ê¸°">Ã—</button>
      </header>
      <div class="modalBody">
        <div class="musicRoom">
          <div class="panel">
            <div class="tools">
              <div class="search">
                ğŸ” <input id="q" type="text" placeholder="ê²€ìƒ‰ (ì œëª©/ì•„í‹°ìŠ¤íŠ¸)" />
              </div>
              <div class="rowBtns">
                <label class="softBtn" title="ì˜¤ë””ì˜¤ íŒŒì¼ ì¶”ê°€">
                  ï¼‹ ë‚´ ì˜¤ë””ì˜¤
                  <input id="addAudio" type="file" accept="audio/*" multiple style="display:none;" />
                </label>
                <button class="softBtn" id="resetListBtn" title="ê¸°ë³¸ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¡œ ì´ˆê¸°í™”">ê¸°ë³¸ìœ¼ë¡œ</button>
              </div>
            </div>
            <div id="list"></div>
          </div>

          <div class="panel">
            <div class="infoTitle" id="trackTitle">Select Music</div>
            <div class="infoArtist" id="trackArtist">Mapo Rainy... Memory</div>
            <div class="infoDesc" id="trackDesc">ë¹„ ì˜¤ëŠ” ë‚ , ì¡°ìš©íˆ í‹€ì–´ë‘ëŠ” í´ë˜ì‹.
ê¸€ì„ ì“°ê¸° ì¢‹ì€ ì˜¨ë„ë¡œ ë§ì¶°ë‘ì—ˆìŠµë‹ˆë‹¤.</div>

            <div class="player">
              <button class="big" id="pPrev" aria-label="ì´ì „">âŸ¨</button>
              <button class="big" id="pPlay" aria-label="ì¬ìƒ/ì¼ì‹œì •ì§€">â–¶</button>
              <button class="big" id="pNext" aria-label="ë‹¤ìŒ">âŸ©</button>
              <div class="prog" aria-label="ì¬ìƒ ì§„í–‰">
                <span class="time" id="tCur">0:00</span>
                <input type="range" id="seek" min="0" max="1" step="0.001" value="0" />
                <span class="time" id="tDur">0:00</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Diary -->
  <section class="overlay" id="diaryModal" aria-modal="true" role="dialog" aria-label="Diary">
    <div class="modal paper">
      <header class="modalHeader">
        <div>
          <div class="h">Diary</div>
          <div class="s">ë¡œì»¬ ì €ì¥(LocalStorage) â€” ì´ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤</div>
        </div>
        <button class="close" data-close="diaryModal" aria-label="ë‹«ê¸°">Ã—</button>
      </header>
      <div class="modalBody">
        <div class="field">
          <label for="diaryTitle">ì œëª©</label>
          <input id="diaryTitle" type="text" placeholder="ì˜¤ëŠ˜ì˜ ì œëª©" />
        </div>
        <div class="field">
          <label for="diaryContent">ë‚´ìš©</label>
          <textarea id="diaryContent" placeholder="ìƒê°ì„ ê¸°ë¡í•˜ì„¸ìš”..."></textarea>
        </div>
        <div class="actions">
          <button class="act" id="saveDiary">ì €ì¥</button>
          <button class="act" id="exportDiary">ë‚´ë³´ë‚´ê¸°</button>
          <button class="act" id="importDiary">ê°€ì ¸ì˜¤ê¸°</button>
          <input id="importDiaryFile" type="file" accept="application/json" style="display:none;" />
          <button class="act" id="clearDiary">ì „ì²´ ì‚­ì œ</button>
        </div>
        <div class="entries" id="diaryList"></div>
      </div>
    </div>
  </section>

  <!-- Writing / Novel -->
  <section class="overlay" id="novelModal" aria-modal="true" role="dialog" aria-label="Writing">
    <div class="modal paper">
      <header class="modalHeader">
        <div>
          <div class="h">Writing</div>
          <div class="s">ì§§ì€ ê¸€/ì†Œì„¤ì„ ì €ì¥í•˜ê³  ëª¨ì•„ë³´ê¸°</div>
        </div>
        <button class="close" data-close="novelModal" aria-label="ë‹«ê¸°">Ã—</button>
      </header>
      <div class="modalBody">
        <div class="field">
          <label for="novelTitle">ì œëª©</label>
          <input id="novelTitle" type="text" placeholder="Chapter title" />
        </div>
        <div class="field">
          <label for="novelContent">ë‚´ìš©</label>
          <textarea id="novelContent" placeholder="ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•˜ì„¸ìš”..."></textarea>
        </div>
        <div class="actions">
          <button class="act" id="saveNovel">ì €ì¥</button>
          <button class="act" id="exportNovel">ë‚´ë³´ë‚´ê¸°</button>
          <button class="act" id="importNovel">ê°€ì ¸ì˜¤ê¸°</button>
          <input id="importNovelFile" type="file" accept="application/json" style="display:none;" />
          <button class="act" id="clearNovel">ì „ì²´ ì‚­ì œ</button>
        </div>
        <div class="entries" id="novelList"></div>
      </div>
    </div>
  </section>

  <!-- Guestbook -->
  <section class="overlay" id="guestModal" aria-modal="true" role="dialog" aria-label="Guestbook">
    <div class="modal paper">
      <header class="modalHeader">
        <div>
          <div class="h">Guestbook</div>
          <div class="s">ê³µê°œ ì‚¬ì´íŠ¸ì—ì„œëŠ” â€˜ê³µìœ  ë°©ëª…ë¡â€™ì´ ë˜ë ¤ë©´ ë°±ì—”ë“œê°€ í•„ìš”í•´ìš” (í˜„ì¬ëŠ” ë¡œì»¬ ì €ì¥)</div>
        </div>
        <button class="close" data-close="guestModal" aria-label="ë‹«ê¸°">Ã—</button>
      </header>
      <div class="modalBody">
        <div class="field">
          <label for="gbName">ì´ë¦„</label>
          <input id="gbName" type="text" placeholder="ë‹‰ë„¤ì„" />
        </div>
        <div class="field">
          <label for="gbMessage">ë©”ì‹œì§€</label>
          <textarea id="gbMessage" placeholder="ì§§ì€ ê°ìƒì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea>
        </div>
        <div class="actions">
          <button class="act" id="addGuest">ë‚¨ê¸°ê¸°</button>
          <button class="act" id="exportGuest">ë‚´ë³´ë‚´ê¸°</button>
          <button class="act" id="importGuest">ê°€ì ¸ì˜¤ê¸°</button>
          <input id="importGuestFile" type="file" accept="application/json" style="display:none;" />
          <button class="act" id="clearGuest">ì „ì²´ ì‚­ì œ</button>
        </div>
        <div class="entries" id="guestList"></div>
      </div>
    </div>
  </section>

  <!-- Map -->
  <section class="overlay" id="mapModal" aria-modal="true" role="dialog" aria-label="Map">
    <div class="modal">
      <header class="modalHeader">
        <div>
          <div class="h">Map</div>
          <div class="s">ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ ì§€ë„ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤</div>
        </div>
        <button class="close" data-close="mapModal" aria-label="ë‹«ê¸°">Ã—</button>
      </header>
      <div class="modalBody" style="padding:0">
        <div class="mapBox">
          <div class="mapPlaceholder" id="mapPlaceholder">
            <div class="mapInner">
              <div class="h">Haneul Park</div>
              <div class="p">í•˜ëŠ˜ê³µì›(ë§ˆí¬)ì˜ ê¸°ì–µì„ ìœ„í•œ ì§€ë„.</div>
              <div class="small">ì™¸ë¶€ iframeì€ í´ë¦­ í›„ ë¡œë“œí•©ë‹ˆë‹¤.</div>
              <div class="row">
                <button class="softBtn" id="loadMapBtn">ì§€ë„ ë¡œë“œ</button>
                <button class="softBtn" id="copyMapLinkBtn">ë§í¬ ë³µì‚¬</button>
              </div>
            </div>
          </div>
          <iframe id="mapFrame" class="mapFrame" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
      </div>
    </div>
  </section>

  <div class="toast" id="toast"></div>

  <script>
    // ===== Helpers
    const $ = (id) => document.getElementById(id);
    const toastEl = $("toast");
    let toastTimer = null;
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove("show"), 2200);
    }

    // ===== Background video sanity check
    const bgVideo = document.getElementById("bgVideo");
    const markVideoReady = () => {
      document.body.classList.add("video-ready");
    };

    if(bgVideo){
      bgVideo.addEventListener("error", () => {
        toast("ë°°ê²½ ì˜ìƒ(london_rain.mp4)ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”. íŒŒì¼ì´ index.htmlê³¼ ê°™ì€ í´ë”ì— ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
      });
      bgVideo.addEventListener("loadeddata", () => {
        // try to play in case the browser delayed autoplay
        bgVideo.play().catch(()=>{});
        if(bgVideo.readyState >= 2) { try{ document.body.classList.add('video-ready'); }catch(_){ } }
      });
    }


    // ===== Audio sanity check (case-sensitive filenames on Vercel/Linux)
    const _musicEl = document.getElementById("music");
    const _rainEl = document.getElementById("rainAudio");
    if(_musicEl){
      _musicEl.addEventListener("error", () => {
        toast("ìŒì•… íŒŒì¼ì„ ëª» ë¶ˆëŸ¬ì™”ì–´ìš”. íŒŒì¼ëª…ì´ ì½”ë“œì™€ ì •í™•íˆ(ëŒ€ì†Œë¬¸ìê¹Œì§€) ê°™ì€ì§€ í™•ì¸í•´ì£¼ì„¸ìš”. ì˜ˆ: Spring.mp3 / Autumn.mp3");
      });
    }
    if(_rainEl){
      _rainEl.addEventListener("error", () => {
        toast("ë¹—ì†Œë¦¬(rain_sound.mp3)ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”. index.htmlê³¼ ê°™ì€ í´ë”ì— ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
      });
    }

    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatTime(sec){
      if(!isFinite(sec) || sec < 0) return "0:00";
      const m = Math.floor(sec/60);
      const s = Math.floor(sec%60);
      return `${m}:${pad2(s)}`;
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===== Clock
    function updateClock(){
      const now = new Date();
      $("clock").textContent = "SEOUL " + now.toLocaleTimeString("ko-KR",{hour12:false});
    }

    // ===== Title typing (one line, white)
    const TYPE_TEXT = "Mapo Rainy... Memory";
    const typingEl = $("typing");
    let ti = 0;
    function typeTick(){
      if(ti >= TYPE_TEXT.length) return;
      typingEl.textContent += TYPE_TEXT.charAt(ti++);
      setTimeout(typeTick, 62);
    }

    // ===== Modals
    function openModal(id){
      const el = $(id);
      if(!el) return;
      el.style.display = "flex";
      // click outside closes
      const handler = (ev) => {
        if(ev.target === el) closeModal(id);
      };
      el.addEventListener("mousedown", handler, { once:true });
    }
    function closeModal(id){
      const el = $(id);
      if(!el) return;
      el.style.display = "none";
    }
    document.querySelectorAll("[data-open]").forEach(btn => {
      btn.addEventListener("click", () => openModal(btn.getAttribute("data-open")));
    });
    document.querySelectorAll("[data-close]").forEach(btn => {
      btn.addEventListener("click", () => closeModal(btn.getAttribute("data-close")));
    });

    // Esc closes any open modal
    document.addEventListener("keydown", (e) => {
      if(e.key !== "Escape") return;
      const open = document.querySelector(".overlay[style*='display: flex']");
      if(open) closeModal(open.id);
    });

    // ===== Audio / Player State
    const STORE = "mrm_v1_state";
    const musicEl = $("music");
    const rainEl  = $("rainAudio");

    const state = {
      started:false,
      idx:0,
      playing:false,
      shuffle:false,
      repeat:"all", // off | all | one
      master:0.80,
      mVol:0.55,
      rVol:0.55,
      mOn:true,
      rOn:true,
      dragging:false
    };
    function loadState(){
      try{
        const s = JSON.parse(localStorage.getItem(STORE));
        if(s) Object.assign(state, s);
      }catch(_){}
    }
    function saveState(){
      const s = {
        idx: state.idx,
        shuffle: state.shuffle,
        repeat: state.repeat,
        master: state.master,
        mVol: state.mVol,
        rVol: state.rVol,
        mOn: state.mOn,
        rOn: state.rOn
      };
      localStorage.setItem(STORE, JSON.stringify(s));
    }

    // ===== Playlist (files should exist in same folder for hosted version)
        const FALLBACK_LIST = [
      { title:"Raindrop Prelude", artist:"FrÃ©dÃ©ric Chopin", file:"chopin_raindrop.mp3", desc:"ë¹—ë°©ìš¸ì²˜ëŸ¼ ë–¨ì–´ì§€ëŠ” ì„ ìœ¨. ë¹„ ì˜¤ëŠ” ë°¤ì— ê°€ì¥ ì˜ ì–´ìš¸ë¦½ë‹ˆë‹¤." },
      { title:"Nocturne Op.9 No.1", artist:"FrÃ©dÃ©ric Chopin", file:"nocturne_op9_1.mp3", desc:"ê³ ìš”í•œ ë°¤, ë§ˆìŒì„ ì²œì²œíˆ ì •ëˆí•´ì£¼ëŠ” ì•¼ìƒê³¡." },
      { title:"Nocturne in C# minor", artist:"FrÃ©dÃ©ric Chopin", file:"nocturne_c_sharp.mp3", desc:"ì°¨ê°€ìš´ ë‹¬ë¹› ê°™ì€ ìŒìƒ‰. ìš°ìš¸ì´ ì•„ë¦„ë‹¤ì›€ìœ¼ë¡œ ë°”ë€ŒëŠ” ìˆœê°„." },
      { title:"Fantaisie-Impromptu", artist:"FrÃ©dÃ©ric Chopin", file:"fantaisie_impromptu.mp3", desc:"ë¹—ì¤„ê¸° ì‚¬ì´ë¡œ ë²ˆì©ì´ëŠ” ê°ì •. ë¹ ë¥´ê²Œ í˜ë €ë‹¤ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤." },
      { title:"Nocturne Op.9 No.2", artist:"FrÃ©dÃ©ric Chopin", file:"chopin_nocturne_2.mp3", desc:"ë¶€ë“œëŸ½ê³  ìœ ëª…í•œ ì„ ìœ¨. ì”ì”í•œ ê¸°ë¡ ì‹œê°„ì—." },
      { title:"Nocturne (alt)", artist:"FrÃ©dÃ©ric Chopin", file:"chopin_nocturne_1.mp3", desc:"ë‹¤ë¥¸ ë²„ì „ì˜ ì•¼ìƒê³¡. ê°™ì€ ë°¤, ë‹¤ë¥¸ ì˜¨ë„." },
      { title:"Air on the G String (BWV 1068)", artist:"J.S. Bach", file:"bach_air.mp3", desc:"ìˆ¨ì„ ê¸¸ê²Œ ì‰¬ê²Œ í•˜ëŠ” ë°”íì˜ ê³µê¸° ê°™ì€ ì„ ìœ¨." },
      { title:"Canon in D (P. 37)", artist:"Johann Pachelbel", file:"pachelbel_canon.mp3", desc:"ë°˜ë³µë˜ëŠ” íŒ¨í„´ì´ ë§ˆìŒì„ ì•ˆì •ì‹œí‚µë‹ˆë‹¤." },
      { title:"TrÃ¤umerei (Dreaming)", artist:"Robert Schumann", file:"schumann_dreaming.mp3", desc:"ì–´ë¦° ì‹œì ˆì˜ ê¿ˆì„ ë– ì˜¬ë¦¬ê²Œ í•˜ëŠ” ë”°ëœ»í•œ ì¥ë©´." },
      { title:"The Four Seasons: Spring", artist:"Antonio Vivaldi", file:"Spring.mp3", desc:"ë´„ì˜ ê³µê¸°. ë¹„ê°€ ê·¸ì¹œ ë’¤ì˜ ë¹›." },
      { title:"The Four Seasons: Summer", artist:"Antonio Vivaldi", file:"Summer.mp3", desc:"ì—¬ë¦„ í­í’ì²˜ëŸ¼ ëª°ì•„ì¹˜ëŠ” ì—ë„ˆì§€." },
      { title:"The Four Seasons: Autumn", artist:"Antonio Vivaldi", file:"Autumn.mp3", desc:"ìˆ˜í™•ì˜ ê³„ì ˆ. ì”ì”í•œ í’ìš”." },
      { title:"Winter: II. Largo", artist:"Antonio Vivaldi", file:"winter_largo.mp3", desc:"ë”°ëœ»í•œ ì‹¤ë‚´, ì°½ë°–ì˜ ë¹—ì†Œë¦¬. ê³ ìš”í•œ ë¼ë¥´ê³ ." }
    ];

    // ===== Load playlist from music.json (recommended for future updates)
    // Put music.json next to index.html. Each item: { file, title, artist, desc }.
    async function loadPlaylistFromJson(){
      try{
        const res = await fetch("music.json?v=" + Date.now(), { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        if(!Array.isArray(data) || data.length === 0) throw new Error("Empty playlist");
        const normalized = data
          .filter(x => x && typeof x.file === "string" && x.file.trim())
          .map(x => ({
            file: (()=>{
                    let f = String(x.file).trim();
                    // If you write only "song.mp3" in music.json, we assume it lives in /music/
                    if(!/^https?:\/\//i.test(f) && !f.includes("/") ) f = "music/" + f;
                    return f;
                  })(),
            title: (x.title ? String(x.title) : String(x.file).replace(/\.[^/.]+$/, "")).trim(),
            artist: (x.artist ? String(x.artist) : "").trim(),
            desc: (x.desc ? String(x.desc) : "").trim(),
          }));
        if(normalized.length === 0) throw new Error("No valid items");
        defaultList = normalized;
        list = [...defaultList];
        toast(`music.json ë¡œë”©ë¨: ${normalized.length}ê³¡`);
        return true;
      }catch(err){
        // If music.json is missing, we simply fall back to built-in list.
        // (This keeps local usage smooth.)
        console.warn("music.json load failed:", err);
        return false;
      }
    }

    let defaultList = [...FALLBACK_LIST];
    let list = [...defaultList];

    // ===== UI refs
    const startBtn = $("startBtn");
    const nowBar = $("nowBar");
    const dock = $("dock");
    const mixer = $("mixer");

    const nowTitle = $("nowTitle");
    const nowArtist = $("nowArtist");
    const playDot = $("playDot");

    const prevBtn = $("prevBtn");
    const playBtn = $("playBtn");
    const nextBtn = $("nextBtn");
    const shuffleBtn = $("shuffleBtn");
    const repeatBtn = $("repeatBtn");

    const mixerBtn = $("mixerBtn");
    const vMaster = $("vMaster");
    const vMusic = $("vMusic");
    const vRain  = $("vRain");
    const togMusic = $("togMusic");
    const togRain  = $("togRain");

    const q = $("q");
    const addAudio = $("addAudio");
    const resetListBtn = $("resetListBtn");
    const listEl = $("list");

    const trackTitle = $("trackTitle");
    const trackArtist = $("trackArtist");
    const trackDesc = $("trackDesc");
    const pPrev = $("pPrev");
    const pPlay = $("pPlay");
    const pNext = $("pNext");
    const seek = $("seek");
    const tCur = $("tCur");
    const tDur = $("tDur");

    function applyVolumes(){
      const m = state.master;
      musicEl.volume = (state.mOn ? state.mVol : 0) * m;
      rainEl.volume  = (state.rOn ? state.rVol : 0) * m;

      vMaster.value = String(state.master);
      vMusic.value = String(state.mVol);
      vRain.value  = String(state.rVol);

      togMusic.classList.toggle("on", state.mOn);
      togMusic.setAttribute("aria-checked", String(state.mOn));
      togRain.classList.toggle("on", state.rOn);
      togRain.setAttribute("aria-checked", String(state.rOn));

      playDot.style.background = state.playing ? "var(--ok)" : "rgba(255,255,255,.35)";
    }

    function updateButtons(){
      const icon = state.playing ? "âšâš" : "â–¶";
      playBtn.textContent = icon;
      pPlay.textContent   = icon;

      shuffleBtn.classList.toggle("active", state.shuffle);

      repeatBtn.classList.remove("active");
      if(state.repeat === "one"){
        repeatBtn.classList.add("active");
        repeatBtn.textContent = "ğŸ”‚";
      }else if(state.repeat === "all"){
        repeatBtn.classList.add("active");
        repeatBtn.textContent = "ğŸ”";
      }else{
        repeatBtn.textContent = "â†©";
      }
    }

    function setMeta(t){
      const title = t?.title || "Untitled";
      const artist = t?.artist || "Unknown";
      trackTitle.textContent = title;
      trackArtist.textContent = artist;
      trackDesc.textContent = t?.desc || "";

      nowTitle.textContent = title;
      nowArtist.textContent = artist;
    }

    function loadSrc(t){
      musicEl.src = t?.objectUrl || t?.file || "";
    }

    function safePlay(el){
      return el.play().catch(() => {
        toast("ë¸Œë¼ìš°ì € ì •ì±…ìƒ â€˜í´ë¦­ í›„â€™ ì¬ìƒë©ë‹ˆë‹¤.");
      });
    }

    function renderList(filter=""){
      const qq = (filter || "").trim().toLowerCase();
      listEl.innerHTML = "";

      const rows = list
        .map((t, i) => ({t, i}))
        .filter(({t}) => !qq || (t.title||"").toLowerCase().includes(qq) || (t.artist||"").toLowerCase().includes(qq));

      if(rows.length === 0){
        listEl.innerHTML = "<div style='padding:16px;opacity:.75;'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”.</div>";
        return;
      }

      rows.forEach(({t, i}) => {
        const div = document.createElement("div");
        div.className = "track" + (i === state.idx ? " active" : "");
        div.innerHTML = `
          <div>
            <div class="tt">${escapeHtml(t.title || "Untitled")}</div>
            <div class="aa">${escapeHtml(t.artist || "Unknown")}</div>
          </div>
          <div style="opacity:.65;">â–¶</div>
        `;
        div.addEventListener("click", () => playAt(i, true));
        listEl.appendChild(div);
      });
    }

    function playAt(i, gesture=false){
      if(!list[i]) return;
      state.idx = i;
      saveState();

      const t = list[i];
      setMeta(t);
      loadSrc(t);
      renderList(q.value || "");

      if(state.mOn){
        if(gesture) safePlay(musicEl);
        else musicEl.play().catch(()=>{});
      }
      state.playing = state.mOn && !musicEl.paused;
      updateButtons();
      applyVolumes();
    }

    function togglePlay(gesture=false){
      if(!state.mOn){
        toast("Musicê°€ êº¼ì ¸ ìˆì–´ìš”. Mixerì—ì„œ Musicë¥¼ ì¼œì£¼ì„¸ìš”.");
        return;
      }
      if(!musicEl.src){
        playAt(state.idx || 0, gesture);
        return;
      }
      if(musicEl.paused){
        if(gesture) safePlay(musicEl);
        else musicEl.play().catch(()=>{});
      }else{
        musicEl.pause();
      }
      state.playing = !musicEl.paused;
      updateButtons();
      applyVolumes();
      saveState();
    }

    function nextTrack(gesture=false){
      if(list.length === 0) return;
      if(state.shuffle && list.length > 1){
        let n = state.idx;
        while(n === state.idx) n = Math.floor(Math.random() * list.length);
        return playAt(n, gesture);
      }
      return playAt((state.idx + 1) % list.length, gesture);
    }

    function prevTrack(gesture=false){
      if(list.length === 0) return;
      if(state.shuffle && list.length > 1){
        let p = state.idx;
        while(p === state.idx) p = Math.floor(Math.random() * list.length);
        return playAt(p, gesture);
      }
      return playAt((state.idx - 1 + list.length) % list.length, gesture);
    }

    // Audio events
    musicEl.addEventListener("ended", () => {
      if(state.repeat === "one"){
        musicEl.currentTime = 0;
        musicEl.play().catch(()=>{});
        return;
      }
      if(state.repeat === "off" && state.idx === list.length - 1){
        state.playing = false;
        updateButtons();
        applyVolumes();
        return;
      }
      nextTrack(false);
    });
    musicEl.addEventListener("error", () => {
      toast("ìŒì•… íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”. ë‹¤ìŒ ê³¡ìœ¼ë¡œ ë„˜ì–´ê°ˆê²Œìš”.");
      setTimeout(() => nextTrack(false), 350);
    });

    // Seek
    musicEl.addEventListener("loadedmetadata", () => {
      tDur.textContent = formatTime(musicEl.duration);
    });
    musicEl.addEventListener("timeupdate", () => {
      if(state.dragging) return;
      tCur.textContent = formatTime(musicEl.currentTime);
      if(isFinite(musicEl.duration) && musicEl.duration > 0){
        seek.value = String(musicEl.currentTime / musicEl.duration);
      }else{
        seek.value = "0";
      }
    });
    seek.addEventListener("input", () => {
      state.dragging = true;
      if(isFinite(musicEl.duration) && musicEl.duration > 0){
        tCur.textContent = formatTime(parseFloat(seek.value) * musicEl.duration);
      }
    });
    seek.addEventListener("change", () => {
      if(isFinite(musicEl.duration) && musicEl.duration > 0){
        musicEl.currentTime = parseFloat(seek.value) * musicEl.duration;
      }
      state.dragging = false;
    });

    // Control bindings
    prevBtn.addEventListener("click", () => prevTrack(true));
    nextBtn.addEventListener("click", () => nextTrack(true));
    playBtn.addEventListener("click", () => togglePlay(true));
    shuffleBtn.addEventListener("click", () => {
      state.shuffle = !state.shuffle;
      saveState();
      updateButtons();
      toast(state.shuffle ? "ì…”í”Œ ON" : "ì…”í”Œ OFF");
    });
    repeatBtn.addEventListener("click", () => {
      if(state.repeat === "off") state.repeat = "all";
      else if(state.repeat === "all") state.repeat = "one";
      else state.repeat = "off";
      saveState();
      updateButtons();
      toast(state.repeat === "one" ? "í•œ ê³¡ ë°˜ë³µ" : (state.repeat === "all" ? "ì „ì²´ ë°˜ë³µ" : "ë°˜ë³µ OFF"));
    });

    pPrev.addEventListener("click", () => prevTrack(true));
    pNext.addEventListener("click", () => nextTrack(true));
    pPlay.addEventListener("click", () => togglePlay(true));

    // Mixer
    vMaster.addEventListener("input", () => { state.master = parseFloat(vMaster.value); saveState(); applyVolumes(); });
    vMusic.addEventListener("input",  () => { state.mVol   = parseFloat(vMusic.value);  saveState(); applyVolumes(); });
    vRain.addEventListener("input",   () => { state.rVol   = parseFloat(vRain.value);   saveState(); applyVolumes(); });

    function toggleSwitch(el, key){
      state[key] = !state[key];
      saveState();
      applyVolumes();

      if(key === "mOn"){
        if(state.mOn){
          toast("Music ON");
          togglePlay(true);
        }else{
          musicEl.pause();
          state.playing = false;
          updateButtons();
          toast("Music OFF");
        }
      }
      if(key === "rOn"){
        if(state.rOn){
          toast("Rain ON");
          rainEl.play().catch(()=>{});
        }else{
          rainEl.pause();
          toast("Rain OFF");
        }
      }
    }
    togMusic.addEventListener("click", () => toggleSwitch(togMusic, "mOn"));
    togRain.addEventListener("click",  () => toggleSwitch(togRain, "rOn"));
    togMusic.addEventListener("keydown", (e) => { if(e.key==="Enter"||e.key===" "){ e.preventDefault(); toggleSwitch(togMusic, "mOn"); }});
    togRain.addEventListener("keydown",  (e) => { if(e.key==="Enter"||e.key===" "){ e.preventDefault(); toggleSwitch(togRain, "rOn"); }});

    mixerBtn.addEventListener("click", () => {
      const show = mixer.style.display !== "block";
      mixer.style.display = show ? "block" : "none";
    });

    // Search & add audio
    q.addEventListener("input", (e) => renderList(e.target.value || ""));
    addAudio.addEventListener("change", (e) => {
      const files = Array.from(e.target.files || []);
      if(files.length === 0) return;
      files.forEach(f => {
        const url = URL.createObjectURL(f);
        const name = f.name.replace(/\.[^/.]+$/, "");
        list.push({ title: name, artist: "Local File", objectUrl: url, desc: "ë‚´ê°€ ì¶”ê°€í•œ ë¡œì»¬ ì˜¤ë””ì˜¤ íŒŒì¼" });
      });
      toast(`ì˜¤ë””ì˜¤ ${files.length}ê°œ ì¶”ê°€ë¨`);
      renderList(q.value || "");
      e.target.value = "";
    });
    resetListBtn.addEventListener("click", () => {
      list = [...defaultList];
      toast("ê¸°ë³¸ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¡œ ì´ˆê¸°í™”");
      renderList(q.value || "");
      if(state.idx >= list.length) state.idx = 0;
      playAt(Math.min(state.idx, list.length-1), false);
    });

    // Keyboard shortcuts (Space, arrows) after started
    document.addEventListener("keydown", (e) => {
      if(!state.started) return;
      const tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
      if(tag === "input" || tag === "textarea") return;

      if(e.key === " "){
        e.preventDefault();
        togglePlay(true);
      }
      if(e.key === "ArrowRight") nextTrack(true);
      if(e.key === "ArrowLeft")  prevTrack(true);
    });

    // ===== Storage: Diary / Novel / Guestbook (LocalStorage)
    const DIARY_KEY = "mrm_v1_diary";
    const NOVEL_KEY = "mrm_v1_novel";
    const GUEST_KEY = "mrm_v1_guest";

    function loadArr(key){
      try{ return JSON.parse(localStorage.getItem(key)) || []; }catch(_){ return []; }
    }
    function saveArr(key, arr){
      localStorage.setItem(key, JSON.stringify(arr));
    }
    function stamp(){
      return new Date().toISOString();
    }
    function prettyDate(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString("ko-KR", { hour12:false });
      }catch(_){ return iso; }
    }

    // Diary
    const diaryTitle = $("diaryTitle");
    const diaryContent = $("diaryContent");
    const diaryList = $("diaryList");
    const importDiaryFile = $("importDiaryFile");

    function renderEntries(key, container, tagLabel){
      const arr = loadArr(key);
      container.innerHTML = "";
      if(arr.length === 0){
        container.innerHTML = "<div style='grid-column:1/-1;opacity:.65;padding:10px 2px;'>ì•„ì§ ê¸€ì´ ì—†ì–´ìš”.</div>";
        return;
      }
      arr.slice().reverse().forEach(item => {
        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `
          <div class="t">${escapeHtml(item.title || "Untitled")}</div>
          <div class="d">${escapeHtml(prettyDate(item.createdAt || ""))}</div>
          <div class="c">${escapeHtml(item.content || "")}</div>
          <div class="mini"><span class="chip">${escapeHtml(tagLabel)}</span></div>
        `;
        container.appendChild(div);
      });
    }

    $("saveDiary").addEventListener("click", () => {
      const title = diaryTitle.value.trim() || "Untitled";
      const content = diaryContent.value.trim();
      if(!content){ toast("ë‚´ìš©ì´ ë¹„ì–´ ìˆì–´ìš”."); return; }
      const arr = loadArr(DIARY_KEY);
      arr.push({ title, content, createdAt: stamp() });
      saveArr(DIARY_KEY, arr);
      diaryTitle.value = "";
      diaryContent.value = "";
      renderEntries(DIARY_KEY, diaryList, "Diary");
      toast("ì €ì¥ë¨");
    });
    $("clearDiary").addEventListener("click", () => {
      if(!confirm("Diary ì „ì²´ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
      saveArr(DIARY_KEY, []);
      renderEntries(DIARY_KEY, diaryList, "Diary");
      toast("ì‚­ì œë¨");
    });
    $("exportDiary").addEventListener("click", () => exportJson(DIARY_KEY, "mapo_rainy_diary.json"));
    $("importDiary").addEventListener("click", () => importDiaryFile.click());
    importDiaryFile.addEventListener("change", (e) => importJson(DIARY_KEY, e.target.files?.[0], () => renderEntries(DIARY_KEY, diaryList, "Diary")));

    // Novel
    const novelTitle = $("novelTitle");
    const novelContent = $("novelContent");
    const novelList = $("novelList");
    const importNovelFile = $("importNovelFile");

    $("saveNovel").addEventListener("click", () => {
      const title = novelTitle.value.trim() || "Untitled";
      const content = novelContent.value.trim();
      if(!content){ toast("ë‚´ìš©ì´ ë¹„ì–´ ìˆì–´ìš”."); return; }
      const arr = loadArr(NOVEL_KEY);
      arr.push({ title, content, createdAt: stamp() });
      saveArr(NOVEL_KEY, arr);
      novelTitle.value = "";
      novelContent.value = "";
      renderEntries(NOVEL_KEY, novelList, "Writing");
      toast("ì €ì¥ë¨");
    });
    $("clearNovel").addEventListener("click", () => {
      if(!confirm("Writing ì „ì²´ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
      saveArr(NOVEL_KEY, []);
      renderEntries(NOVEL_KEY, novelList, "Writing");
      toast("ì‚­ì œë¨");
    });
    $("exportNovel").addEventListener("click", () => exportJson(NOVEL_KEY, "mapo_rainy_writing.json"));
    $("importNovel").addEventListener("click", () => importNovelFile.click());
    importNovelFile.addEventListener("change", (e) => importJson(NOVEL_KEY, e.target.files?.[0], () => renderEntries(NOVEL_KEY, novelList, "Writing")));

    // Guestbook
    const gbName = $("gbName");
    const gbMessage = $("gbMessage");
    const guestList = $("guestList");
    const importGuestFile = $("importGuestFile");

    $("addGuest").addEventListener("click", () => {
      const name = gbName.value.trim() || "Anonymous";
      const message = gbMessage.value.trim();
      if(!message){ toast("ë©”ì‹œì§€ê°€ ë¹„ì–´ ìˆì–´ìš”."); return; }
      const arr = loadArr(GUEST_KEY);
      arr.push({ title: name, content: message, createdAt: stamp() });
      saveArr(GUEST_KEY, arr);
      gbName.value = "";
      gbMessage.value = "";
      renderEntries(GUEST_KEY, guestList, "Guestbook");
      toast("ë‚¨ê²¨ì¡Œì–´ìš”");
    });
    $("clearGuest").addEventListener("click", () => {
      if(!confirm("Guestbook ì „ì²´ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
      saveArr(GUEST_KEY, []);
      renderEntries(GUEST_KEY, guestList, "Guestbook");
      toast("ì‚­ì œë¨");
    });
    $("exportGuest").addEventListener("click", () => exportJson(GUEST_KEY, "mapo_rainy_guestbook.json"));
    $("importGuest").addEventListener("click", () => importGuestFile.click());
    importGuestFile.addEventListener("change", (e) => importJson(GUEST_KEY, e.target.files?.[0], () => renderEntries(GUEST_KEY, guestList, "Guestbook")));

    function exportJson(key, filename){
      const data = localStorage.getItem(key) || "[]";
      const blob = new Blob([data], { type:"application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
      toast("ë‚´ë³´ë‚´ê¸° ì™„ë£Œ");
    }
    function importJson(key, file, done){
      if(!file){ return; }
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const arr = JSON.parse(reader.result);
          if(!Array.isArray(arr)) throw new Error("not array");
          saveArr(key, arr);
          done && done();
          toast("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ");
        }catch(_){
          toast("JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.");
        }
      };
      reader.readAsText(file);
    }

    // ===== Map
    const MAP_Q = "ì„œìš¸ ë§ˆí¬êµ¬ í•˜ëŠ˜ê³µì›";
    const MAP_URL = "https://maps.google.com/maps?q=" + encodeURIComponent(MAP_Q) + "&t=m&z=15&output=embed&iwloc=near";
    $("loadMapBtn").addEventListener("click", () => {
      $("mapFrame").src = MAP_URL;
      $("mapFrame").style.display = "block";
      $("mapPlaceholder").style.display = "none";
      toast("ì§€ë„ ë¡œë“œë¨");
    });
    $("copyMapLinkBtn").addEventListener("click", async () => {
      const link = "https://maps.google.com/?q=" + encodeURIComponent(MAP_Q);
      try{
        await navigator.clipboard.writeText(link);
        toast("ì§€ë„ ë§í¬ ë³µì‚¬ë¨");
      }catch(_){
        toast("ë³µì‚¬ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”");
      }
    });

    // ===== Start Experience (fixes your console error)
    async function startExperience(){
      if(state.started) return;
      state.started = true;
      startBtn.disabled = true;
      startBtn.textContent = "Started";

      nowBar.style.display = "flex";
      dock.style.display = "flex";

      // rain sound (gesture required)
      try{ if(state.rOn) await rainEl.play(); }catch(_){}
      // start first track
      playAt(state.idx || 0, true);

      try{ if(typeof bgVideo !== 'undefined' && bgVideo){ bgVideo.muted = true; bgVideo.play().catch(()=>{});
        if(bgVideo.readyState >= 2) { try{ document.body.classList.add('video-ready'); }catch(_){ } } } }catch(_){ }

      toast("Welcome to Mapo Rainy... Memory");
    }
    startBtn.addEventListener("click", startExperience);

    // Sync play/pause
    musicEl.addEventListener("play",  () => { state.playing = true; updateButtons(); applyVolumes(); saveState(); });
    musicEl.addEventListener("pause", () => { state.playing = false; updateButtons(); applyVolumes(); saveState(); });

    // Init
    window.addEventListener("load", () => {
      updateClock();
      setInterval(updateClock, 1000);

      // Boot
      async function init(){
        loadState();
        // Load remote playlist first (if provided), then render.
        await loadPlaylistFromJson();
        applyVolumes();
        updateButtons();

        // initial render
        typeTick();
        if(state.idx >= list.length) state.idx = 0;
        setMeta(list[state.idx] || list[0] || {});
        renderList("");
      }
      init();
renderEntries(DIARY_KEY, diaryList, "Diary");
      renderEntries(NOVEL_KEY, novelList, "Writing");
      renderEntries(GUEST_KEY, guestList, "Guestbook");
    });
  </script>
</body>
</html>
